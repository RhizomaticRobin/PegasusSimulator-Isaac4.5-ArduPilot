# ArduPilot Isaac Sim 4.5 Compatibility Fix

This directory contains the analysis and fix for making ArduPilot work with Isaac Sim 4.5 in PegasusSimulator.

## Quick Start

```bash
# 1. Apply ArduPilot-specific fixes
python fix_ardupilot_for_isaac_4.5.py

# 2. Apply general Isaac Sim 4.5 migration
python migrate_to_isaac_4.5.py

# 3. Test the fixes
python test_ardupilot_compatibility.py
```

## The Problem

ArduPilot backend in PegasusSimulator v4.5.0 is broken due to:
1. Isaac Sim API namespace changes (omni.isaac.* → isaacsim.*)
2. Dynamic control API location changes
3. World transform API modifications

## The Solution

### What Needs Fixing

1. **Vehicle Base Class** (`vehicle.py`)
   - `omni.isaac.dynamic_control` → `isaacsim.core.dynamic_control`
   - `omni.usd.get_world_transform_matrix()` → Direct USD API usage

2. **Multirotor Class** (`multirotor.py`)
   - `omni.isaac.dynamic_control` → `isaacsim.core.dynamic_control`

### What Doesn't Need Fixing

- **ArduPilot Backend** - No Isaac Sim dependencies ✅
- **Sensors** (IMU, GPS, etc.) - Work with State objects ✅
- **MAVLINK Communication** - Pure Python implementation ✅
- **Coordinate Transforms** - Already handled correctly ✅

## Files Included

1. **ARDUPILOT_ISAAC_SIM_4.5_FIX_PLAN.md** - Detailed technical analysis
2. **fix_ardupilot_for_isaac_4.5.py** - Automated fix script
3. **test_ardupilot_compatibility.py** - Test script (generated by fix script)

## How It Works

The ArduPilot data flow:
```
Isaac Sim Physics
    ↓
Vehicle.update_state() [FIXED]
    ↓
State Object (position, orientation, velocity)
    ↓
Sensors (IMU, GPS, Barometer, Magnetometer)
    ↓
ArduPilot Backend
    ↓
MAVLINK/JSON Protocol
    ↓
ArduPilot SITL
```

## Testing

After applying fixes:

1. **Basic Test**
   ```bash
   python test_ardupilot_compatibility.py
   ```

2. **Full Test**
   ```bash
   cd examples
   python 11_ardupilot_multi_vehicle.py
   ```

3. **Flight Test**
   - Arm vehicle
   - Take off
   - Hover
   - Land

## Troubleshooting

If issues persist:

1. **Check Backups**
   - Files are backed up with `.ardupilot_backup` extension
   - Restore if needed: `mv file.py.ardupilot_backup file.py`

2. **Verify Isaac Sim Version**
   ```python
   import isaacsim
   print(isaacsim.__version__)  # Should be 4.5.x
   ```

3. **Check Dynamic Control**
   - The dynamic control API may have changed
   - Check Isaac Sim 4.5 documentation for updates

## Contributing

If you get ArduPilot working:
1. Test thoroughly
2. Document any additional changes
3. Submit PR to PegasusSimulator repo
4. Help others in the community!

## Status

⚠️ **EXPERIMENTAL** - These fixes are based on the migration documentation but haven't been tested with actual hardware/SITL yet. Use with caution!